<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>FlowGraph - Lit Example</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  html, body {
    height: 100%; 
    margin: 0; 
    background: linear-gradient(180deg, #091027 0%, #071420 100%); 
    font-family: 'Inter', 'Roboto', system-ui, sans-serif; 
    color: #fff;
    overflow: hidden;
  }
  
  #app {
    position: relative; 
    height: 100vh; 
    width: 100vw; 
    overflow: hidden; 
    display: flex;
  }

  flow-context-menu {
    --context-menu-min-width: 300px;
    --context-menu-max-width: 450px;
  }
  </style>
  <!-- Use bundled FlowGraph with CSS -->
  <link rel="stylesheet" href="dist/flowgraph.css">
  <script type="module" src="dist/flowgraph.es.js"></script>
</head>
<body>
  <div id="app">
    <!-- Graph execution controls -->
    <div style="position: absolute; top: 10px; left: 10px; z-index: 1000; display: flex; gap: 10px;">
      <button id="execute-graph-btn" style="
        padding: 8px 16px;
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        transition: all 0.2s ease;
      " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
        üöÄ Execute Graph
      </button>
      <div style="
        padding: 8px 12px;
        background: rgba(0,0,0,0.7);
        color: #10b981;
        border-radius: 6px;
        font-size: 12px;
        font-family: monospace;
        border: 1px solid rgba(16,185,129,0.3);
      ">
        Shift+Enter
      </div>
    </div>
    
    <flow-graph theme="dark" snap-to-grid grid-size="20">
      <flow-definitions>
        <!-- Number Input Node -->
        <flow-node-def name="data.number" label="Number" width="160" height="100" category="Data" description="Outputs a numeric value" icon="üî¢" 
                       color-bg="linear-gradient(90deg, rgba(59,130,246,0.15), transparent)" color-text="#3b82f6" onExecute="loadData">
          <node-body>
            <div class="title">üî¢ Number</div>
            <div class="body">
              <input type="number" class="input-box" value="0" placeholder="Enter value">
              <div class="line" style="text-align:right">
                <span class="socket out" data-sock="value"></span> Value
              </div>
            </div>
          </node-body>
          <flow-output socket="value" label="Value" type="number"></flow-output>
        </flow-node-def>
        
        <!-- Math Add Node -->
        <flow-node-def name="math.add" label="Add" width="180" height="120" category="Math" description="Adds two numbers together" icon="‚ûï" 
                       color-bg="linear-gradient(90deg, rgba(245,158,11,0.15), transparent)" color-text="#f59e0b" onExecute="addNumbers">
          <node-body>
            <div class="title">‚ûï Add</div>
            <div class="body">
              <div class="line">
                <span class="socket in" data-sock="a"></span> A
              </div>
              <div class="line">
                <span class="socket in" data-sock="b"></span> B
              </div>
              <div style="height:8px"></div>
              <div class="line" style="text-align:right">
                <span class="socket out" data-sock="sum"></span> Sum
              </div>
            </div>
          </node-body>
          <flow-input socket="a" label="A" type="number"></flow-input>
          <flow-input socket="b" label="B" type="number"></flow-input>
          <flow-output socket="sum" label="Sum" type="number"></flow-output>
        </flow-node-def>
        
        <!-- Watch Node -->
        <flow-node-def name="data.watch" label="Watch" width="160" height="100" category="Data" description="Displays input value" icon="üëÅÔ∏è" onExecute="watchValue">
          <node-body>
            <div class="title">üëÅÔ∏è Watch</div>
            <div class="body">
              <div class="line">
                <span class="socket in" data-sock="value"></span> Value
              </div>
            </div>
          </node-body>
          <flow-input socket="value" label="Value" type="any"></flow-input>
        </flow-node-def>
        
        <!-- Multiply Node -->
        <flow-node-def name="math.multiply" label="Multiply" width="180" height="120" category="Math" description="Multiplies two numbers" icon="‚úñÔ∏è" onExecute="multiplyNumbers">
          <node-body>
            <div class="title">‚úñÔ∏è Multiply</div>
            <div class="body">
              <div class="line">
                <span class="socket in" data-sock="a"></span> A
              </div>
              <div class="line">
                <span class="socket in" data-sock="b"></span> B
              </div>
              <div style="height:8px"></div>
              <div class="line" style="text-align:right">
                <span class="socket out" data-sock="product"></span> Product
              </div>
            </div>
          </node-body>
          <flow-input socket="a" label="A" type="number"></flow-input>
          <flow-input socket="b" label="B" type="number"></flow-input>
          <flow-output socket="product" label="Product" type="number"></flow-output>
        </flow-node-def>
        
        <!-- Split Node -->
        <flow-node-def name="util.split" label="Split" width="160" height="140" category="Utility" description="Splits input into two outputs" icon="üîÄ" onExecute="splitValue">
          <node-body>
            <div class="title">üîÄ Split</div>
            <div class="body">
              <div class="line">
                <span class="socket in" data-sock="input"></span> Input
              </div>
              <div style="height:8px"></div>
              <div class="line" style="text-align:right">
                <span class="socket out" data-sock="out1"></span> Out 1
              </div>
              <div class="line" style="text-align:right">
                <span class="socket out" data-sock="out2"></span> Out 2
              </div>
              <div class="line" style="text-align:right">
                <span class="socket out" data-sock="out3"></span> Out 3
              </div>
            </div>
          </node-body>
          <flow-input socket="input" label="Input" type="any"></flow-input>
          <flow-output socket="out1" label="Out 1" type="any"></flow-output>
          <flow-output socket="out2" label="Out 2" type="any"></flow-output>
          <flow-output socket="out3" label="Out 3" type="any"></flow-output>
        </flow-node-def>
        
        <!-- Advanced 3D Renderer Node - Shows arbitrary HTML content with data-draggable attributes -->
        <flow-node-def name="render.3d" label="3D Renderer" width="320" height="280" category="Render" description="Advanced 3D rendering with controls" icon="üé®" onExecute="render3D">
          <node-body>
            <div class="title">üéÆ 3D Renderer</div>
            <div class="body">
              <!-- Input sockets -->
              <div class="line">
                <span class="socket in" data-sock="mesh"></span> Mesh Data
              </div>
              <div class="line">
                <span class="socket in" data-sock="camera"></span> Camera
              </div>
              
              <!-- 3D Canvas (simulated) -->
              <div style="margin: 8px 0; border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; background: linear-gradient(45deg, #1a1a2e, #16213e); height: 120px; position: relative; overflow: hidden;">
                <canvas width="280" height="110" style="width: 100%; height: 100%; cursor: grab;" data-draggable="false"></canvas>
                <div style="position: absolute; top: 4px; right: 4px; font-size: 10px; color: rgba(255,255,255,0.5);">WebGL</div>
                <div style="position: absolute; bottom: 4px; left: 4px; font-size: 10px; color: rgba(255,255,255,0.5);">FPS: 60</div>
              </div>
              
              <!-- Various control types -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin: 8px 0;">
                <div>
                  <label style="font-size: 10px; color: rgba(255,255,255,0.7);">Rotation X:</label>
                  <input type="range" min="0" max="360" value="45" data-draggable="false" style="width: 100%; accent-color: #10b981;">
                </div>
                <div>
                  <label style="font-size: 10px; color: rgba(255,255,255,0.7);">Rotation Y:</label>
                  <input type="range" min="0" max="360" value="30" data-draggable="false" style="width: 100%; accent-color: #10b981;">
                </div>
              </div>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin: 4px 0;">
                <select class="input-box" data-draggable="false" style="font-size: 11px;">
                  <option>Perspective</option>
                  <option>Orthographic</option>
                  <option>Isometric</option>
                </select>
                <input type="color" value="#10b981" data-draggable="false" style="width: 100%; height: 24px; border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; background: transparent;">
              </div>
              
              <div style="margin: 4px 0;">
                <textarea class="input-box" data-draggable="false" placeholder="Shader code..." rows="2" style="resize: vertical; font-family: monospace; font-size: 10px;"></textarea>
              </div>
              
              <div style="display: flex; gap: 4px; margin: 4px 0;">
                <button data-draggable="false" style="flex: 1; padding: 4px 8px; background: rgba(16,185,129,0.2); border: 1px solid #10b981; color: #10b981; border-radius: 4px; font-size: 10px; cursor: pointer;">Render</button>
                <button data-draggable="false" style="flex: 1; padding: 4px 8px; background: rgba(239,68,68,0.2); border: 1px solid #ef4444; color: #ef4444; border-radius: 4px; font-size: 10px; cursor: pointer;">Reset</button>
              </div>
              
              <!-- Output sockets -->
              <div style="height:8px"></div>
              <div class="line" style="text-align:right">
                <span class="socket out" data-sock="render"></span> Rendered
              </div>
              <div class="line" style="text-align:right">
                <span class="socket out" data-sock="stats"></span> Stats
              </div>
            </div>
          </node-body>
          <flow-input socket="mesh" label="Mesh Data" type="object"></flow-input>
          <flow-input socket="camera" label="Camera" type="object"></flow-input>
          <flow-output socket="render" label="Rendered" type="texture"></flow-output>
          <flow-output socket="stats" label="Stats" type="object"></flow-output>
        </flow-node-def>
        
        <!-- Logic Node -->
        <flow-node-def name="logic.if" label="If" width="160" height="120" category="Logic" description="Conditional logic" icon="‚ö°" 
                       color-bg="linear-gradient(90deg, rgba(239,68,68,0.15), transparent)" color-text="#ef4444" onExecute="conditionalLogic">
          <node-body>
            <div class="title">‚ö° If</div>
            <div class="body">
              <div class="line">
                <span class="socket in" data-sock="condition"></span> Condition
              </div>
              <div style="height:8px"></div>
              <div class="line" style="text-align:right">
                <span class="socket out" data-sock="true"></span> True
              </div>
              <div class="line" style="text-align:right">
                <span class="socket out" data-sock="false"></span> False
              </div>
            </div>
          </node-body>
          <flow-input socket="condition" label="Condition" type="boolean"></flow-input>
          <flow-output socket="true" label="True" type="any"></flow-output>
          <flow-output socket="false" label="False" type="any"></flow-output>
        </flow-node-def>
        
        <!-- Text Node -->
        <flow-node-def name="text.string" label="String" width="160" height="100" category="Text" description="Text input/output" icon="üìù" 
                       color-bg="linear-gradient(90deg, rgba(59,130,246,0.15), transparent)" color-text="#3b82f6" onExecute="processString">
          <node-body>
            <div class="title">üìù String</div>
            <div class="body">
              <input type="text" class="input-box" value="Hello" placeholder="Enter text">
              <div class="line" style="text-align:right">
                <span class="socket out" data-sock="text"></span> Text
              </div>
            </div>
          </node-body>
          <flow-output socket="text" label="Text" type="string"></flow-output>
        </flow-node-def>
        
        <!-- Canvas Node -->
        <flow-node-def name="render.canvas" label="Canvas" width="200" height="150" category="Render" description="2D Canvas renderer" icon="üé®" 
                       color-bg="linear-gradient(90deg, rgba(139,92,246,0.15), transparent)" color-text="#8b5cf6" onExecute="renderCanvas">
          <node-body>
            <div class="title">üé® Canvas</div>
            <div class="body">
              <canvas data-draggable="false" style="width: 100%; height: 60px; background: #000; border-radius: 4px;"></canvas>
              <div class="line" style="text-align:right">
                <span class="socket out" data-sock="image"></span> Image
              </div>
            </div>
          </node-body>
          <flow-output socket="image" label="Image" type="image"></flow-output>
        </flow-node-def>
      </flow-definitions>
      
      <flow-nodes>
        <!-- Create some example nodes -->
        <flow-node type="data.number" id="n1" x="100" y="100"></flow-node>
        <flow-node type="data.number" id="n2" x="100" y="250"></flow-node>
        <flow-node type="math.add" id="n3" x="350" y="175"></flow-node>
        <flow-node type="math.multiply" id="n4" x="600" y="100"></flow-node>
        <flow-node type="util.split" id="n5" x="850" y="150"></flow-node>
        <flow-node type="data.watch" id="n6" x="1100" y="100"></flow-node>
        <flow-node type="data.watch" id="n7" x="1100" y="200"></flow-node>
        <!-- Advanced 3D Renderer Node with arbitrary HTML content -->
        <flow-node type="render.3d" id="n8" x="400" y="350"></flow-node>
      </flow-nodes>
      
      <flow-edges>
        <!-- Create some example connections -->
        <flow-edge from="n1:value" to="n3:a"></flow-edge>
        <flow-edge from="n2:value" to="n3:b"></flow-edge>
        <flow-edge from="n3:sum" to="n4:a"></flow-edge>
        <flow-edge from="n1:value" to="n4:b"></flow-edge>
        <flow-edge from="n4:product" to="n5:input"></flow-edge>
        <flow-edge from="n5:out1" to="n6:value"></flow-edge>
        <flow-edge from="n5:out2" to="n7:value"></flow-edge>
      </flow-edges>
    </flow-graph>
  </div>
  
  <script type="module">
    // Wait for custom elements to be defined
    await customElements.whenDefined('flow-graph');
    
    // Example of programmatic API usage
    const flowGraph = document.querySelector('flow-graph');
    
    flowGraph.addEventListener('node:create', (e) => {
      console.log('Node created:', e.detail.node);
    });
    
    flowGraph.addEventListener('edge:create', (e) => {
      console.log('Edge created:', e.detail.edge);
    });
    
    
    // Node selection events
    flowGraph.addEventListener('node:select', (e) => {
      console.log('üéØ Node selected:', e.detail.nodeId, 'Selection:', e.detail.selection);
    });
    
    flowGraph.addEventListener('node:deselect', (e) => {
      console.log('‚ùå Node deselected:', e.detail.nodeId, 'Selection:', e.detail.selection);
    });
    
    flowGraph.addEventListener('selection:clear', (e) => {
      console.log('üßπ Selection cleared, previous:', e.detail.previousSelection);
    });
    
    // Node movement events
    flowGraph.addEventListener('node:move', (e) => {
      console.log('üöÄ Node moved:', e.detail.nodeId, 
        'from', e.detail.oldPosition, 'to', e.detail.newPosition);
    });
    
    // Edge selection events
    flowGraph.addEventListener('edge:select', (e) => {
      console.log('üîó Edge selected:', e.detail.edgeId);
    });
    
    flowGraph.addEventListener('edge:deselect', (e) => {
      console.log('üîó Edge deselected:', e.detail.edgeId);
    });
    
    // Viewport events
    flowGraph.addEventListener('viewport:change', (e) => {
      console.log('üìê Viewport changed:', e.detail);
    });
    
    flowGraph.addEventListener('viewport:zoom', (e) => {
      console.log('üîç Zoomed to:', e.detail.scale);
    });
    
    flowGraph.addEventListener('viewport:pan', (e) => {
      console.log('üëÜ Panned to:', e.detail.x, e.detail.y);
    });
    
    // Keyboard shortcut events
    flowGraph.addEventListener('selection:change', (e) => {
      console.log('üìã Selection changed:', e.detail.selectedNodes.length, 'nodes selected');
    });
    
    flowGraph.addEventListener('nodes:copy', (e) => {
      console.log('üìã Nodes copied:', e.detail.copiedNodes.length, 'nodes,', e.detail.copyData.edges.length, 'edges');
    });
    
    flowGraph.addEventListener('nodes:paste', (e) => {
      console.log('üìã Nodes pasted:', e.detail.pastedNodes.length, 'nodes');
    });
    
    flowGraph.addEventListener('nodes:delete', (e) => {
      console.log('üóëÔ∏è Nodes deleted:', e.detail.deletedNodes.length, 'nodes,', e.detail.deletedEdges.length, 'edges');
    });
    
    // Node execution events
    flowGraph.addEventListener('node:execute', (e) => {
      console.log('‚ö° Node executed:', e.detail.nodeId);
    });
    
    flowGraph.addEventListener('node:execute:error', (e) => {
      console.error('‚ùå Node execution error:', e.detail.nodeId, 'Error:', e.detail.error);
    });
    
    // Graph execution events
    flowGraph.addEventListener('graph:execute:start', (e) => {
      console.log('üöÄ Graph execution started');
    });
    
    flowGraph.addEventListener('graph:execute:complete', (e) => {
      console.log('‚úÖ Graph execution completed');
    });
    
    // Execute graph button
    document.getElementById('execute-graph-btn').addEventListener('click', async () => {
      console.log('üöÄ Executing entire graph...');
      await flowGraph.flowGraph.execute();
    });
    
    
    // Wait for the component to be fully initialized
    const waitForFlowGraph = () => {
      return new Promise((resolve) => {
        if (flowGraph.flowGraph && flowGraph.flowGraph.nodes) {
          resolve();
        } else {
          setTimeout(() => waitForFlowGraph().then(resolve), 50);
        }
      });
    };
    
    await waitForFlowGraph();
    console.log('FlowGraph loaded with', flowGraph.flowGraph.nodes.size, 'nodes');
    
    // Multi-drag instructions
    console.log('üí° Multi-drag: Select multiple nodes with Ctrl/Cmd+click, then drag any selected node to move all together!');
    
    // Context menu instructions
    console.log('üéØ Context Menu: Right-click on empty space to add new nodes from the context menu!');
    
    // Execution instructions
    console.log('‚ö° Execution: Double-click a node, Ctrl/Cmd+Enter for selected nodes, or Shift+Enter for entire graph!');
    
    // Async onExecuteMethod functions for all flow-node-def elements
    // Make functions globally accessible
    window.loadData = async function(context) {
      console.log('üî¢ Loading data for Number node:', context);
      
      // Access the DOM element directly
      const inputElement = context.element.querySelector('input[type="number"]');
      const value = inputElement ? parseFloat(inputElement.value) || 0 : 0;
      
      // Simulate async data loading
      await new Promise(resolve => setTimeout(resolve, 100));
      
      console.log('Number value:', value);
      
      // Set output value (index 0 for first output socket)
      context.setOutput(0, value);
    };
    
    window.addNumbers = async function(context) {
      console.log('‚ûï Adding numbers:', context);
      
      // Get input values using index (a=0, b=1)
      const a = context.getInput(0) || 0;
      const b = context.getInput(1) || 0;
      
      // Simulate async calculation
      await new Promise(resolve => setTimeout(resolve, 50));
      
      const sum = a + b;
      console.log(`Adding ${a} + ${b} = ${sum}`);
      
      // Set output value (index 0 for first output socket)
      context.setOutput(0, sum);
    };
    
    window.watchValue = async function(context) {
      console.log('üëÅÔ∏è Watching value:', context);
      
      // Get input value (index 0 for first input socket)
      const value = context.getInput(0);
      
      // Simulate async value processing
      await new Promise(resolve => setTimeout(resolve, 30));
      
      console.log('Watched value:', value);
    };
    
    window.multiplyNumbers = async function(context) {
      console.log('‚úñÔ∏è Multiplying numbers:', context);
      
      // Get input values (a=0, b=1)
      const a = context.getInput(0) || 1;
      const b = context.getInput(1) || 1;
      
      // Simulate async calculation
      await new Promise(resolve => setTimeout(resolve, 50));
      
      const product = a * b;
      console.log(`Multiplying ${a} * ${b} = ${product}`);
      
      // Set output value (index 0 for first output socket)
      context.setOutput(0, product);
    };
    
    window.splitValue = async function(context) {
      console.log('üîÄ Splitting value:', context);
      
      // Get input value (index 0 for first input socket)
      const input = context.getInput(0);
      
      // Simulate async value splitting
      await new Promise(resolve => setTimeout(resolve, 40));
      
      // Set multiple output values (out1=0, out2=1, out3=2)
      context.setOutput(0, input); // out1
      context.setOutput(1, input); // out2
      context.setOutput(2, input); // out3
    };
    
    window.render3D = async function(context) {
      console.log('üé® Rendering 3D:', context);
      
      // Get input values
      const meshData = context.getInput(0);
      const camera = context.getInput(1);
      
      // Simulate async 3D rendering
      await new Promise(resolve => setTimeout(resolve, 200));
      
      // Set output values
      context.setOutput(0, '3D rendered content'); // render
      context.setOutput(1, { fps: 60, triangles: 1000 }); // stats
    };
    
    window.conditionalLogic = async function(context) {
      console.log('‚ö° Processing conditional logic:', context);
      
      // Get input value
      const condition = Boolean(context.getInput(0));
      
      // Simulate async condition evaluation
      await new Promise(resolve => setTimeout(resolve, 60));
      
      // Set output values
      context.setOutput(0, condition ? context.getInput(0) : null); // true
      context.setOutput(1, !condition ? context.getInput(0) : null); // false
    };
    
    window.processString = async function(context) {
      console.log('üìù Processing string:', context);
      
      // Access the DOM element directly
      const inputElement = context.element.querySelector('input[type="text"]');
      const text = inputElement ? inputElement.value : '';
      
      // Simulate async string processing
      await new Promise(resolve => setTimeout(resolve, 30));
      
      console.log('Processed text:', text);
      
      // Set output value
      context.setOutput(0, text);
    };
    
    window.renderCanvas = async function(context) {
      console.log('üé® Rendering canvas:', context);
      
      // Simulate async canvas rendering
      await new Promise(resolve => setTimeout(resolve, 100));
      
      // Set output value
      context.setOutput(0, 'canvas rendered image data');
    };
  </script>
</body>
</html>
